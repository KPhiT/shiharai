<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>忘年会 支払額計算</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="忘年会精算">

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 12px; margin: 0; background: #f7f7f7; }
    h1 { font-size: 1.4em; }
    h2 { font-size: 1.2em; margin-top: 20px; }
    label { display: block; margin-top: 8px; font-size: 0.9em; }
    input, select, button {
      width: 100%;
      font-size: 1.1em;
      padding: 14px;
      margin-top: 6px;
      box-sizing: border-box;
      touch-action: manipulation;
    }
    button {
      background: #007aff;
      color: #fff;
      border: none;
      border-radius: 12px;
      min-height: 48px;
    }
    button + button { margin-top: 8px; }
    .group { background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    #result p { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>忘年会 支払額計算アプリ</h1>

  <label>
    合計金額：
    <input type="number" id="totalAmount" value="0" />
  </label>

  <h2>グループ</h2>
  <div id="groups"></div>

  <button onclick="addGroup()">グループ追加</button>
  <button onclick="calculate()">計算</button>

  <h2>結果</h2>
  <div id="result"></div>

<script>
let groupId = 0;

function addGroup() {
  const groupsDiv = document.getElementById('groups');
  const div = document.createElement('div');
  div.className = 'group';
  div.dataset.id = groupId++;

  div.innerHTML = `
    <label>グループ名：<input type="text" class="name" value="グループ${groupId}" /></label>
    <label>人数：<input type="number" class="people" value="1" /></label>
    <label>
      支払い方法：
      <select class="type">
        <option value="fixed">金額指定</option>
        <option value="rate">傾斜(係数)</option>
      </select>
    </label>
    <label>金額 or 係数：<input type="number" class="value" value="0" /></label>
    <label><input type="checkbox" class="organizer" /> 幹事（端数調整）</label>
    <button onclick="this.parentElement.remove()" style="background:#ff3b30;margin-top:10px;">グループ削除</button>
  `;

  groupsDiv.appendChild(div);
}

function calculate() {
  const total = Number(document.getElementById('totalAmount').value);
  const groups = document.querySelectorAll('.group');

  let fixedTotal = 0;
  let rateSum = 0;
  let organizerIndex = -1;

  const data = [];

  groups.forEach((g, index) => {
    const name = g.querySelector('.name').value;
    const people = Number(g.querySelector('.people').value);
    const type = g.querySelector('.type').value;
    const value = Number(g.querySelector('.value').value);
    const organizer = g.querySelector('.organizer').checked;

    if (organizer) organizerIndex = index;
    if (type === 'fixed') fixedTotal += value;
    if (type === 'rate') rateSum += value * people;

    data.push({ name, people, type, value, organizer, total: 0 });
  });

  const remain = total - fixedTotal;
  let calculatedSum = 0;

  data.forEach((d, i) => {
    if (d.type === 'fixed') {
      d.total = d.value;
    } else {
      d.total = Math.round(remain * (d.value * d.people) / rateSum);
    }
    calculatedSum += d.total;
  });

  const diff = total - calculatedSum;
  if (organizerIndex >= 0) {
    data[organizerIndex].total += diff;
  }

  let html = '';
  data.forEach(d => {
    let perPerson = Math.round(d.total / d.people);
    // 500円単位で丸め（四捨五入）
    perPerson = Math.round(perPerson / 500) * 500;
    html += `<p><strong>${d.name}</strong>：合計 ${d.total} 円（1人 ${perPerson} 円）${d.organizer ? ' ※幹事' : ''}</p>`;
  });

  document.getElementById('result').innerHTML = html;
}
}

addGroup();
</script>
</body>
</html>
