<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>支払額計算</title>

  <style>
    :root {
      --bg: #f7f7f7;
      --card: #ffffff;
      --text: #000000;
      --primary: #007aff;
      --danger: #ff3b30;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --card: #1e1e1e;
        --text: #ffffff;
        --primary: #0a84ff;
        --danger: #ff453a;
      }
    }
    body {
      margin: 0;
      padding: 12px;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    h1 { font-size: 1.4em; }
    label { display: block; margin-top: 8px; }
    input, select, button {
      width: 100%;
      font-size: 1.1em;
      padding: 14px;
      margin-top: 6px;
      box-sizing: border-box;
      border-radius: 12px;
    }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      min-height: 48px;
    }
    .danger { background: var(--danger); }
    .group {
      background: var(--card);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    #result p {
      background: var(--card);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <h1>支払額計算</h1>

  <label>
    合計金額
    <input type="number" id="totalAmount" />
  </label>

  <h2>グループ</h2>
  <div id="groups"></div>

  <button id="addBtn">グループ追加</button>
  <button id="calcBtn">計算</button>

  <h2>結果</h2>
  <div id="result"></div>

<script>
// ===== 安定版 完成コード =====
let groupId = 0;

function saveState() {
  const state = {
    totalAmount: document.getElementById('totalAmount').value,
    groups: [...document.querySelectorAll('.group')].map(g => ({
      name: g.querySelector('.name').value,
      people: g.querySelector('.people').value,
      type: g.querySelector('.type').value,
      value: g.querySelector('.value').value,
      organizer: g.querySelector('.organizer').checked
    }))
  };
  localStorage.setItem('bonenkaiState', JSON.stringify(state));
}

function loadState() {
  const raw = localStorage.getItem('bonenkaiState');
  if (!raw) return false;
  const state = JSON.parse(raw);
  document.getElementById('totalAmount').value = state.totalAmount || '';
  state.groups.forEach(g => addGroup(g));
  return true;
}

function addGroup(data = {}) {
  const div = document.createElement('div');
  div.className = 'group';

  div.innerHTML = `
    <label>グループ名
      <input class="name" value="${data.name || 'グループ' + (groupId + 1)}">
    </label>
    <label>人数
      <input type="number" class="people" value="${data.people || 1}">
    </label>
    <label>支払い方法
      <select class="type">
        <option value="fixed">金額指定</option>
        <option value="rate">傾斜(係数)</option>
      </select>
    </label>
    <label>金額 / 係数
      <input type="number" class="value" value="${data.value || 0}">
    </label>
    <label>
      <input type="checkbox" class="organizer"> 幹事（端数調整）
    </label>
    <button class="danger">グループ削除</button>
  `;

  document.getElementById('groups').appendChild(div);

  if (data.type) div.querySelector('.type').value = data.type;
  if (data.organizer) div.querySelector('.organizer').checked = true;

  // イベント
  div.querySelector('.danger').addEventListener('click', () => {
    div.remove();
    saveState();
  });

  div.querySelector('.organizer').addEventListener('change', e => {
    if (e.target.checked) {
      document.querySelectorAll('.organizer').forEach(cb => {
        if (cb !== e.target) cb.checked = false;
      });
    }
    saveState();
  });

  div.querySelectorAll('input,select').forEach(el => {
    el.addEventListener('change', saveState);
  });

  groupId++;
  saveState();
}

function calculate() {
  const total = Number(document.getElementById('totalAmount').value);
  const groups = document.querySelectorAll('.group');

  let fixed = 0;
  let rateSum = 0;
  let organizerIndex = -1;
  let totalPeople = 0;

  const data = [];

  groups.forEach((g, i) => {
    const d = {
      name: g.querySelector('.name').value,
      people: Number(g.querySelector('.people').value),
      type: g.querySelector('.type').value,
      value: Number(g.querySelector('.value').value),
      organizer: g.querySelector('.organizer').checked,
      total: 0
    };
    totalPeople += d.people;
    if (d.organizer) organizerIndex = i;
    if (d.type === 'fixed') fixed += d.value;
    if (d.type === 'rate') rateSum += d.value * d.people;
    data.push(d);
  });

  const remain = total - fixed;
  let sum = 0;

  data.forEach(d => {
    if (d.type === 'fixed') {
      d.total = d.value;
    } else {
      let per = remain * (d.value * d.people) / rateSum / d.people;
      per = Math.round(per / 500) * 500;
      d.total = per * d.people;
    }
    sum += d.total;
  });

  if (organizerIndex >= 0) {
    data[organizerIndex].total += (total - sum);
  }

  let html = `<p><strong>合計人数：</strong>${totalPeople} 人</p>`;
  data.forEach(d => {
    html += `<p><strong>${d.name}</strong>：合計 ${d.total} 円（1人 ${Math.round(d.total / d.people)} 円）${d.organizer ? ' ※幹事' : ''}</p>`;
  });

  document.getElementById('result').innerHTML = html;
}

// 初期化
document.getElementById('addBtn').addEventListener('click', () => addGroup());
document.getElementById('calcBtn').addEventListener('click', calculate);

if (!loadState()) addGroup();
</script>
</body>
</html>
